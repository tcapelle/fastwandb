# AUTOGENERATED! DO NOT EDIT! File to edit: nbs/01_datasets.ipynb (unless otherwise specified).

__all__ = ['PROJECT_NAME', 'JOB_TYPE', 'ENTITY', 'upload_folder', 'ImageTable', 'label_image_name', 'label_image_image']

# Cell
from .imports import *
from .image import *

PROJECT_NAME = "fastwandb"
JOB_TYPE     = "upload_data"
ENTITY       = "tcapelle"

# Cell
def upload_folder(path: File, name='dataset', metadata={}, description='dataset'):
    "Upload all files in path"
    path = Path(path)
    artifact_dataset = wandb.Artifact(name=name,
                                      type='dataset',
                                      metadata=metadata,
                                      description=description)

    #upload folders and files insidet `path`
    for f in path.iterdir():
        if f.is_dir():
            artifact_dataset.add_dir(f, name=f.name)
        else:
            artifact_dataset.add_file(f)
    return wandb.run.use_artifact(artifact_dataset)

# Cell
class ImageTable(wandb.Table):
    """A basic Table containing images.
    Args:
    - image_paths List[Path]: A list of paths referencing images.
    - label_func  Callable: A function to label images.
    """
    def __init__(self, image_paths, label_func):
        super().__init__(columns=['img', 'label'])
        for img_path in image_paths:
            self.add_data(wandb.Image(str(img_path)), label_func(img_path))

    @classmethod
    def from_folder(cls, folder_path, label_func):
        files = Path(folder_path).ls()
        cls(files, label_func)

    def log_to_workspace(self, name='table'):
        wandb.log({name: self})

    @delegates(wandb.Artifact, but='name, type')
    def log_to_artifact(self, name, type, tag=None, **kwargs):
        artifact = wandb.Artifact(name=name, type=type, **kwargs)
        artifact["data"] = self

        if tag is not None:
            wandb.log_artifact(artifact, aliases=[tag, "latest"])
        else:
            wandb.log_artifact(artifact)

        # log Table to the workspace for easier visualization
        self.log_to_workspace()

# Cell
def label_image_name(path):
    "get name from image fname"
    return path.name.split('.')[0]

def label_image_image(path):
    "Autoencoder task"
    return wandb.Image(str(path))